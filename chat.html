<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>UB GlobalPal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Chat-specific styles */
    :root {
      --ub-blue: #005bbb;
      --ub-gray: #5e6a71;
      --bg-light: #f8f9fa;
    }

    body {
      background-color: #e9ecef;
      font-family: 'Inter', sans-serif;
    }

    /* Center the chat app below the navbar */
    .app-container {
      max-width: 450px;
      height: calc(100vh - 100px); /* Full height minus rough navbar height */
      min-height: 500px;
      margin: 20px auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-radius: 16px;
      overflow: hidden;
    }

    /* HEADER inside chat window */
    .header {
      background: var(--ub-blue);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-icon { font-size: 28px; }
    .header-text h1 { margin: 0; font-size: 18px; font-weight: 700; }
    .header-text p { margin: 2px 0 0; font-size: 12px; opacity: 0.9; }

    /* CHAT AREA */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .bot {
      background: #fff;
      color: #212529;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-right: auto;
    }
    .user {
      background: var(--ub-blue);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }

    /* QUICK REPLIES */
    .quick-replies {
      padding: 12px 15px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      background: #fff;
      border-top: 1px solid #eee;
      scrollbar-width: none; /* Firefox */
    }
    .quick-replies::-webkit-scrollbar { display: none; /* Chrome/Safari */ }
    
    .chip {
      white-space: nowrap;
      background: #f1f3f5;
      color: var(--ub-blue);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .chip:hover {
      background: var(--ub-blue);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,91,187,0.2);
    }

    /* INPUT */
    .input-zone {
      padding: 15px;
      background: #fff;
      border-top: 1px solid #f1f3f5;
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 30px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    #user-input:focus { border-color: var(--ub-blue); }
    #send-btn {
      background: var(--ub-blue);
      color: #fff;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s, background-color 0.2s;
    }
    #send-btn:hover { transform: scale(1.05); background-color: #004a99; }
    #send-btn:disabled { background: #ccc; transform: none; }

    /* Loading animation */
    .loading-dots::after {
      content: ' .';
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ' .'; }
      40%     { content: ' ..'; }
      60%     { content: ' ...'; }
      80%,100%{ content: ' '; }
    }
  </style>
</head>
<body>

  <div class="topnav">
    <div class="topnav-content">
      <div class="nav-left">
        <img src="ub.jpg" alt="UB Logo" class="logo">
        <span class="logo-text">UBverse</span>
      </div>
      <div class="nav-right">
        <a href="index.html">Home</a>
        <a href="chat.html" class="active">Chat</a>
        <a href="translator.html">Translator</a>
        <a href="map.html">Map</a>
        <a href="region.html">Region Matcher</a>
        <a href="mood.html">Mood Tracker</a>
      </div>
    </div>
  </div>

  <div class="app-container">
    <div class="header">
      <div class="header-icon">üêÇ</div>
      <div class="header-text">
        <h1>UB GlobalPal</h1>
        <p>AI Student Assistant</p>
      </div>
    </div>

    <div id="chat-box">
      <div class="message bot">
        <strong>Hello! I'm GlobalPal üêÇüíô</strong><br><br>
        I'm here to help you navigate life at UB. Ask me about dining, Orientation, campus buses, or just tell me if you're feeling overwhelmed!
      </div>
    </div>

    <div class="quick-replies">
      <div class="chip" onclick="ask('Where can I find halal food near campus?')">üåØ Halal Food</div>
      <div class="chip" onclick="ask('How do I use the UB Stampede bus?')">üöå Bus Guide</div>
      <div class="chip" onclick="ask('I feel lonely and homesick today.')">üòî Feeling Homesick</div>
      <div class="chip" onclick="ask('What are the best study spots at UB?')">üìö Study Spots</div>
    </div>

    <form class="input-zone" id="chat-form">
      <input type="text" id="user-input" placeholder="Type your question here..." autocomplete="off" />
      <button type="submit" id="send-btn">‚û§</button>
    </form>
  </div>

  <script>
    const chatBox   = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn   = document.getElementById('send-btn');
    let history = []; // conversation context

    function appendMessage(text, sender, isLoading = false) {
      const div = document.createElement('div');
      div.className = `message ${sender} ${isLoading ? 'loading-dots' : ''}`;
      div.innerHTML = String(text).replace(/\n/g, '<br>');
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    async function ask(query) {
      if (!query) return;

      appendMessage(query, 'user');
      userInput.value = '';
      sendBtn.disabled = true;
      const loadingMsg = appendMessage('Thinking', 'bot', true);

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: query, history })
        });
        const data = await res.json();

        chatBox.removeChild(loadingMsg);
        // Handle both success 'reply' and potential 'error' from server
        appendMessage(data.reply || ("‚ö†Ô∏è " + data.error) || 'Sorry, I had a glitch.', 'bot');

        if (data.reply) {
          history.push({ role: "user",  parts: [{ text: query }] });
          history.push({ role: "model", parts: [{ text: data.reply }] });
        }
      } catch (err) {
        chatBox.removeChild(loadingMsg);
        appendMessage("‚ö†Ô∏è Connection failed. Is the server running?", 'bot');
        console.error("Chat Error:", err);
      }
      sendBtn.disabled = false;
    }

    // Allow clicking chips to send message
    window.ask = ask; 

    // Handle form submit
    document.getElementById('chat-form').addEventListener('submit', (e) => {
      e.preventDefault();
      ask(userInput.value.trim());
    });
  </script>
</body>
</html>